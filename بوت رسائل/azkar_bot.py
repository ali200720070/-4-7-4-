#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
ุจูุช ุงูุฃุฐูุงุฑ ุงูุจุณูุท
===============
- ูุฑุณู ุฐูุฑูุง ูู ุณุงุนุชูู ูู ุฃู ูุฌููุนุฉ ูุชู ุฅุถุงูุชู ุฅูููุง
- ูุญุฐู ุงูุฑุณุงูุฉ ุงูุณุงุจูุฉ ุนูุฏ ุฅุฑุณุงู ุฑุณุงูุฉ ุฌุฏูุฏุฉ
- ูุนูู ูุน ุฌููุน ุฅุตุฏุงุฑุงุช ููุชุจุฉ ุงูุชููุฌุฑุงู
- ุจุฏูู ุฃู ุชุนููุฏุงุช ุฃู ุฅุนุฏุงุฏุงุช ูุนูุฏุฉ
"""

import os
import logging
from datetime import datetime, timedelta
from dotenv import load_dotenv

# ุชุญููู ููุชุจุงุช ุงูุชููุฌุฑุงู
from telegram import Update
from telegram.ext import (
    Application,
    MessageHandler,
    CommandHandler,
    ChatMemberHandler,
    ContextTypes,
)
from telegram.ext import filters

# --- ุฅุนุฏุงุฏุงุช ุงูุชุณุฌูู ---
# ====================

logging.basicConfig(
    format='%(asctime)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# --- ูุงุฆูุฉ ุงูุฃุฐูุงุฑ ---
# =================

AZKAR_LIST = [
    "๐ธ ุงููููููููู ุจููู ุฃูุตูุจูุญูููุงุ ููุจููู ุฃูููุณูููููุงุ ููุจููู ููุญูููุงุ ููุจููู ูููููุชูุ ููุฅููููููู ุงููููุดููุฑู. (ูุชูู ุนููู)",
    "๐ ุงููููููููู ุฃูููุชู ุฑูุจููู ููุง ุฅููููู ุฅููููุง ุฃูููุชูุ ุฎูููููุชูููู ููุฃูููุง ุนูุจูุฏูููุ ููุฃูููุง ุนูููู ุนูููุฏููู ููููุนูุฏููู ููุง ุงุณูุชูุทูุนูุชูุ ุฃูุนููุฐู ุจููู ูููู ุดูุฑูู ููุง ุตูููุนูุชูุ ุฃูุจููุกู ูููู ุจูููุนูููุชููู ุนููููููุ ููุฃูุจููุกู ุจูุฐูููุจูู ููุงุบูููุฑู ููู ููุฅูููููู ููุง ููุบูููุฑู ุงูุฐูููููุจู ุฅููููุง ุฃูููุชู. (ูุชูู ุนููู)",
    "๐ฟ ููุง ุฅููููู ุฅููููุง ุงูููููู ููุญูุฏููู ููุง ุดูุฑูููู ููููุ ูููู ุงูููููููู ูููููู ุงููุญูููุฏูุ ูููููู ุนูููู ููููู ุดูููุกู ููุฏููุฑู. (ูุชูู ุนููู)",
    "๐ธ ๏ดฟุงูููููู ููุง ุฅููููู ุฅููููุง ูููู ุงููุญูููู ุงูููููููููู  ููุข ุชูุฃูุฎูุฐููู ุณูููุฉู ููููุง ูููููู  ูููู ููุง ููู ุงูุณููููุงููุงุชู ููููุง ููู ุงููุฃูุฑูุถู  ูููู ุฐูุง ุงูููุฐูู ููุดูููุนู ุนูููุฏููู ุฅููููุง ุจูุฅูุฐููููู  ููุนููููู ููุง ุจููููู ุฃูููุฏูููููู ููููุง ุฎููููููููู  ููููุง ููุญููุทูููู ุจูุดูููุกู ูููู ุนููููููู ุฅููููุง ุจูููุง ุดูุงุกู  ููุณูุนู ููุฑูุณูููููู ุงูุณููููุงููุงุชู ููุงููุฃูุฑูุถู  ููููุง ููุฆููุฏููู ุญูููุธูููููุง  ูููููู ุงููุนูููููู ุงููุนูุธูููู๏ดพ (ุงูุจูุฑุฉ:255)",
    "๐ฟ ููุง ุญูููู ููุง ูููููููู ุจูุฑูุญูููุชููู ุฃูุณูุชูุบููุซูุ ุฃูุตูููุญู ููู ุดูุฃูููู ูููููููุ ููููุง ุชูููููููู ุฅูููู ููููุณูู ุทูุฑูููุฉู ุนููููู. (ูุชูู ุนููู)",
    "๐ ุจูุณููู ุงูููููู ุงูููุฐูู ููุง ููุถูุฑูู ููุนู ุงุณููููู ุดูููุกู ููู ุงููุฃูุฑูุถู ููููุง ููู ุงูุณููููุงุกู ูููููู ุงูุณูููููุนู ุงููุนูููููู. (ุซูุงุซ ูุฑุงุช) (ุฑูุงู ูุณูู)",
    "๐ธ ุงููููููููู ุฅููููู ุฃูุณูุฃููููู ูููู ุงููุฎูููุฑู ููููููู ุนูุงุฌููููู ููุขุฌูููููุ ููุง ุนูููููุชู ูููููู ููููุง ูููู ุฃูุนูููููุ ููุฃูุนููุฐู ุจููู ูููู ุงูุดููุฑูู ููููููู ุนูุงุฌููููู ููุขุฌูููููุ ููุง ุนูููููุชู ูููููู ููููุง ูููู ุฃูุนููููู. (ุฑูุงู ูุณูู)",
    "๐ฟ ุงููููููููู ุฃูุตูููุญู ููู ุฏููููู ุงูููุฐูู ูููู ุนูุตูููุฉู ุฃูููุฑููุ ููุฃูุตูููุญู ููู ุฏูููููุงูู ุงูููุชูู ูููููุง ููุนูุงุดููุ ููุฃูุตูููุญู ููู ุขุฎูุฑูุชูู ุงูููุชูู ูููููุง ููุนูุงุฏูู. (ูุชูู ุนููู)",
    "๐ ุงููููููููู ุฑูุจููููุง ุขุชูููุง ููู ุงูุฏููููููุง ุญูุณูููุฉู ููููู ุงูุขุฎูุฑูุฉู ุญูุณูููุฉู ููููููุง ุนูุฐูุงุจู ุงููููุงุฑู. (ูุชูู ุนููู)",
    "๐ธ ููุง ูููููููุจู ุงูููููููุจู ุซูุจููุชู ููููุจูู ุนูููู ุฏูููููู. (ุฑูุงู ูุณูู)",
    "๐ฟ ุฑูุจูู ุงุบูููุฑู ููู ููุชูุจู ุนูููููู ุฅูููููู ุฃูููุชู ุงูุชูููููุงุจู ุงูุบููููุฑู. (ูุชูู ุนููู)",
    "๐ ุงููููููููู ุตูููู ููุณูููููู ุนูููู ููุจููููููุง ููุญููููุฏู ๏ทบ ููุนูููู ุขูููู ููุตูุญูุจููู ุฃูุฌูููุนูููู. (ูุชูู ุนููู)",
]

# --- ุงููุฆุฉ ุงูุฑุฆูุณูุฉ ---
# ==================

class SimpleAzkarBot:
    def __init__(self, token):
        self.application = Application.builder().token(token).build()
        self.chat_states = {}  # ุชุฎุฒูู ุญุงูุฉ ูู ุฏุฑุฏุดุฉ (ุงููุคุดุฑ ุงูุญุงูู)
        self.setup_handlers()
    
    def setup_handlers(self):
        """ุฅุถุงูุฉ ุงููุนุงูุฌุงุช ุงูุถุฑูุฑูุฉ"""
        self.application.add_handler(CommandHandler("start", self.start))
        # ุชุชุจุน ุฅุถุงูุฉ ุงูุจูุช ุฅูู ุงููุฌููุนุงุช ุฃู ุงููููุงุช
        self.application.add_handler(ChatMemberHandler(self.track_chats, ChatMemberHandler.MY_CHAT_MEMBER))
        # ุจุฏุก ุงููููุฉ ุนูุฏ ุฅุฑุณุงู ุฃู ุฑุณุงูุฉ ูู ููุงุฉ ุฃู ูุฌููุนุฉ
        self.application.add_handler(MessageHandler(filters.UpdateType.CHANNEL_POST | filters.UpdateType.MESSAGE, self.handle_message))
    async def start(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """ุฑุณุงูุฉ ุชุฑุญูุจ ุจุณูุทุฉ"""
        await update.message.reply_text(
            "ุฃููุงู ุจู! ุฃูุง ุจูุช ุงูุฃุฐูุงุฑุ ุณุฃุฑุณู ุฐูุฑูุง ูู ุณุงุนุชูู ูู ูุฐู ุงููุฌููุนุฉ."
        )
    
    def get_next_zikr(self, chat_id):
        """ุงูุญุตูู ุนูู ุงูุฐูุฑ ุงูุชุงูู ูุน ุชุญุฏูุซ ุงููุคุดุฑ"""
        if chat_id not in self.chat_states:
            self.chat_states[chat_id] = 0
        
        current_index = self.chat_states[chat_id]
        zikr = AZKAR_LIST[current_index]
        
        # ุชุญุฏูุซ ุงููุคุดุฑ ููุฐูุฑ ุงูุชุงูู
        self.chat_states[chat_id] = (current_index + 1) % len(AZKAR_LIST)
        
        return zikr
    
    async def send_zikr(self, context: ContextTypes.DEFAULT_TYPE):
        """ุฅุฑุณุงู ุงูุฐูุฑ ูุญุฐู ุงูุฑุณุงูุฉ ุงูุณุงุจูุฉ"""
        job = context.job
        chat_id = job.chat_id
        
        try:
            # ุญุฐู ุงูุฑุณุงูุฉ ุงูุณุงุจูุฉ ุฅุฐุง ูุฌุฏุช
            if job.data and 'last_message_id' in job.data:
                try:
                    await context.bot.delete_message(
                        chat_id=chat_id,
                        message_id=job.data['last_message_id']
                    )
                except Exception:
                    pass  # ุชุฌุงูู ุฃุฎุทุงุก ุงูุญุฐู
            
            # ุฅุฑุณุงู ุงูุฐูุฑ ุงูุฌุฏูุฏ
            zikr = self.get_next_zikr(chat_id)
            message = await context.bot.send_message(
                chat_id=chat_id,
                text=f"๐ฟ *ุฐูุฑ ูุฏุนุงุก*\n\n{zikr}",
                parse_mode="Markdown"
            )
            
            # ุญูุธ ูุนุฑู ุงูุฑุณุงูุฉ ูุญุฐููุง ูุงุญููุง
            job.data = {'last_message_id': message.message_id}
            
        except Exception as e:
            error_msg = str(e).lower()
            # ุงูุชุญูู ูู ุฃุฎุทุงุก ุดุงุฆุนุฉ
            if "bot was kicked" in error_msg or "chat not found" in error_msg or "not found" in error_msg:
                # ุชู ุฅุฒุงูุฉ ุงูุจูุช ูู ุงููุฌููุนุฉ
                context.job_queue.scheduler.remove_job(job.id)
            else:
                logger.error(f"ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุฐูุฑ ุฅูู {chat_id}: {str(e)}")
    
    async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """ูุนุงูุฌุฉ ุงูุฑุณุงุฆู ุงูุฌุฏูุฏุฉ ูู ุงููุฌููุนุงุช ุฃู ุงููููุงุช ูุจุฏุก ุงููููุฉ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ"""
        chat = update.effective_chat
        if chat:
            chat_id = chat.id
            # ุงูุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ูููุฉ ุญุงููุฉ ูุจู ุงูุจุฏุก
            if not context.job_queue.get_jobs_by_name(str(chat_id)):
                self.start_zikr_job(context, chat_id, chat.title)
    async def track_chats(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """ุชุชุจุน ุฅุถุงูุฉ ุงูุจูุช ุฅูู ุงููุฌููุนุงุช ุงูุฌุฏูุฏุฉ"""
        if not update.chat_member:
            return
        
        chat = update.chat_member.chat
        chat_id = chat.id
        new_status = update.chat_member.new_chat_member.status
        bot_id = context.bot.id
        
        # ุงูุชุฃูุฏ ุฃู ุงูุชุญุฏูุซ ุฎุงุต ุจุงูุจูุช
        if update.chat_member.new_chat_member.user.id != bot_id:
            return
        
        if new_status in ["member", "administrator"]:
            # ุชู ุฅุถุงูุฉ ุงูุจูุช ุฅูู ุงููุฌููุนุฉ
            self.start_zikr_job(context, chat_id, chat.title)

    def start_zikr_job(self, context: ContextTypes.DEFAULT_TYPE, chat_id: int, chat_title: str):
        """ุจุฏุก ูููุฉ ุฅุฑุณุงู ุงูุฃุฐูุงุฑ ูุฏุฑุฏุดุฉ ูุนููุฉ"""
        logger.info(f"ุจุฏุก ูููุฉ ุงูุฃุฐูุงุฑ ูู {chat_title} ({chat_id})")

        # ุฅุฒุงูุฉ ุฃู ููุงู ููุฌูุฏุฉ ูุณุจููุง ููุฐู ุงูุฏุฑุฏุดุฉ
        for job in context.job_queue.get_jobs_by_name(str(chat_id)):
            job.schedule_removal()

        # ุจุฏุก ูููุฉ ุฅุฑุณุงู ุงูุฃุฐูุงุฑ (ูู 30 ุซุงููุฉ)
        context.job_queue.run_repeating(
            self.send_zikr,
            interval=7200,  # 7200 ุซุงููุฉ = ุณุงุนุชุงู
            first=1,      # ูุจุฏุฃ ุจุนุฏ ุซุงููุฉ ูุงุญุฏุฉ ูู ุงูุชุดุบูู
            chat_id=chat_id,
            name=str(chat_id)
        )
    def run(self):
        """ุชุดุบูู ุงูุจูุช"""
        logger.info("ูุชู ุชุดุบูู ุจูุช ุงูุฃุฐูุงุฑ...")
        self.application.run_polling()

# --- ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ ---
# ===================

def main():
    # ุชุญููู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ูู ููู .env
    load_dotenv()

    # ุชุญููู ุฑูุฒ ุงูุจูุช ูู ูุชุบูุฑ ุงูุจูุฆุฉ
    token = os.getenv('BOT_TOKEN')
    if not token:
        logger.error("ูุฑุฌู ุชุนููู ูุชุบูุฑ ุงูุจูุฆุฉ BOT_TOKEN")
        return
    
    bot = SimpleAzkarBot(token)
    bot.run()

if __name__ == '__main__':
    main()